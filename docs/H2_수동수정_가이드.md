# H2 DB 수동 수정 가이드

## 1. H2 콘솔 접속

1. **Spring Boot 서버를 실행한 상태**에서 브라우저에서 접속:
   ```
   http://localhost:8080/h2-console
   ```

2. **접속 정보** (application.properties 기준):
   | 항목 | 값 |
   |------|-----|
   | JDBC URL | `jdbc:h2:file:./data/afbscenter;MODE=MySQL;AUTO_SERVER=TRUE` |
   | User Name | `sa` |
   | Password | *(비워두기)* |

3. **Connect** 클릭 후 SQL 실행 창에서 아래 쿼리 사용.

---

## 2. 이용권(member_products) 잔여 횟수 수정

- **테이블**: `member_products`
- **잔여 횟수 컬럼**: `remaining_count`
- **총 횟수 컬럼**: `total_count` (필요 시)

### 특정 이용권 잔여만 바꾸기

```sql
-- 먼저 해당 이용권 ID 확인 (회원/상품으로 찾기)
SELECT id, member_id, product_id, remaining_count, total_count, status
FROM member_products
WHERE member_id = (SELECT id FROM members WHERE name LIKE '%회원이름%')
  AND status = 'ACTIVE';

-- 잔여 3회로 수정 (id는 위에서 확인한 값으로 변경)
UPDATE member_products
SET remaining_count = 3
WHERE id = 1;
```

### 예약에서 이용권 ID 확인 후 수정

```sql
-- 2월 9일 예약에 연결된 이용권 ID 확인
SELECT b.id AS booking_id, b.member_product_id, b.start_time, mp.remaining_count
FROM bookings b
LEFT JOIN member_products mp ON b.member_product_id = mp.id
WHERE b.start_time >= '2026-02-09' AND b.start_time < '2026-02-10';

-- 해당 member_product_id의 잔여 수정
UPDATE member_products SET remaining_count = 3 WHERE id = (원하는_ID);
```

---

## 3. 체크인 차감(DEDUCT) 히스토리 수동 추가

체크인은 했는데 차감이 안 돼서, **차감 기록만 나중에 넣고 싶을 때** 사용.

- **테이블**: `member_product_history`
- **type**: `DEDUCT` (차감)
- **change_amount**: `-1` (1회 차감)
- **remaining_count_after**: 차감 후 잔여 (예: 3)
- **attendance_id**: 해당 체크인(출석) ID (있으면 넣기)

### 해당 예약의 출석(체크인) ID 확인

```sql
SELECT a.id AS attendance_id, a.booking_id, a.check_in_time
FROM attendances a
JOIN bookings b ON a.booking_id = b.id
WHERE b.start_time >= '2026-02-09' AND b.start_time < '2026-02-10';
```

### DEDUCT 히스토리 한 건 넣기

```sql
-- 아래 값은 실제 ID/날짜로 바꿔서 사용
INSERT INTO member_product_history (
  member_product_id,
  member_id,
  attendance_id,
  transaction_date,
  type,
  change_amount,
  remaining_count_after,
  description
) VALUES (
  1,                    -- 이용권 ID (member_products.id)
  1,                    -- 회원 ID (members.id)
  1,                    -- 출석 ID (attendances.id, 없으면 NULL)
  CURRENT_TIMESTAMP,    -- 거래 일시
  'DEDUCT',             -- 차감
  -1,                   -- 1회 차감
  3,                    -- 차감 후 잔여 횟수
  '체크인으로 인한 차감 (수동 반영)'
);
```

- `attendance_id`가 없으면 `NULL`로 두어도 됨.
- `member_id`는 해당 이용권의 `member_id`와 동일하게.

---

## 4. 횟수 조정(ADJUST) 히스토리 수동 추가

앱에서 “횟수 조정”을 하지 않고 **잔여만 DB에서 바꾼 경우**, 회차 표시를 맞추려면 ADJUST 기록을 넣어 두는 것이 좋음.

```sql
-- H2에서는 VALUES 안에 서브쿼리 사용 시 NULL 오류 나므로 INSERT ... SELECT 사용
INSERT INTO member_product_history (
  member_product_id, member_id, transaction_date, type, change_amount,
  remaining_count_after, description
)
SELECT 1, mp.member_id, CURRENT_TIMESTAMP, 'ADJUST', -1, 3, '수동 조정(DB 반영): 4회 → 3회'
FROM member_products mp WHERE mp.id = 1;
```

- `change_amount` = (조정 후 잔여) - (조정 전 잔여)
- `remaining_count_after` = 조정 후 잔여 (지금 `member_products.remaining_count`에 넣은 값과 맞추기)

---

## 5. 자주 쓰는 확인 쿼리

```sql
-- 이용권 목록 (잔여/총 횟수)
SELECT mp.id, m.name AS member_name, p.name AS product_name,
       mp.remaining_count, mp.total_count, mp.status
FROM member_products mp
JOIN members m ON mp.member_id = m.id
JOIN products p ON mp.product_id = p.id
WHERE mp.status = 'ACTIVE'
ORDER BY mp.id DESC;

-- 특정 이용권의 히스토리 (차감/충전/조정)
SELECT id, type, change_amount, remaining_count_after, transaction_date, description
FROM member_product_history
WHERE member_product_id = 1
ORDER BY transaction_date DESC;
```

---

## 주의사항

- **서버 실행 중**에 H2 콘솔로 접속해야 같은 DB 파일을 사용합니다.
- 수정 후 앱에서는 **새로고침** 또는 **다시 조회**하면 반영된 값이 보입니다.
- `member_products.remaining_count`와 `member_product_history`의 `remaining_count_after`가 서로 맞도록 수정하는 것이 좋습니다.
