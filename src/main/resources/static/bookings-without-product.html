<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>ì´ìš©ê¶Œ ë¯¸ì—°ê²° ì˜ˆì•½ ê´€ë¦¬ - AFBS ì„¼í„°</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/bookings.css">
</head>
<body class="booking-page">
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">âš¾ AFBS ì„¼í„°</div>
                <div class="sidebar-subtitle">ìš´ì˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
            </div>
            <nav class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-section-title">ì£¼ìš” ë©”ë‰´</div>
                    <a href="/" class="menu-item" data-role="Front"><span class="menu-item-icon">ğŸ“Š</span><span>ëŒ€ì‹œë³´ë“œ</span></a>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">íšŒì› ê´€ë¦¬</div>
                    <a href="/members.html" class="menu-item" data-role="Front"><span class="menu-item-icon">ğŸ‘¥</span><span>íšŒì› ê´€ë¦¬</span></a>
                    <a href="/coaches.html" class="menu-item" data-role="Manager"><span class="menu-item-icon">ğŸƒ</span><span>ì½”ì¹˜/ë ˆìŠ¨ ê´€ë¦¬</span></a>
                    <div style="margin-left: 12px; margin-top: 12px; margin-bottom: 4px; font-size: 11px; color: var(--text-secondary); font-weight: 600;">ì¶œì„ë¶€</div>
                    <a href="/attendance.html" class="menu-item menu-item--attendance" data-role="Front"><span class="menu-item-icon">âœ“</span><span>ì¶œì„/ì´ìš© ê¸°ë¡</span></a>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">ì˜ˆì•½ ê´€ë¦¬</div>
                    <a href="/bookings-without-product.html" class="menu-item active" data-role="Admin"><span class="menu-item-icon">âš ï¸</span><span>ì´ìš©ê¶Œ ë¯¸ì—°ê²° ì˜ˆì•½ ê´€ë¦¬</span></a>
                    <div style="margin-left: 12px; margin-top: 8px; margin-bottom: 4px; font-size: 11px; color: var(--text-secondary); font-weight: 600;">ğŸ“ ì‚¬í•˜ì </div>
                    <a href="/bookings.html" class="menu-item" data-role="Front"><span class="menu-item-icon">âš¾</span><span>ì•¼êµ¬</span></a>
                    <a href="/bookings-saha-youth.html" class="menu-item" data-role="Front"><span class="menu-item-icon">ğŸ‘¶</span><span>ì•¼êµ¬(ìœ ì†Œë…„)</span></a>
                    <a href="/bookings-saha-training.html" class="menu-item" data-role="Front"><span class="menu-item-icon">ğŸ’ª</span><span>íŠ¸ë ˆì´ë‹+í•„ë¼í…ŒìŠ¤</span></a>
                    <div style="margin-left: 12px; margin-top: 12px; margin-bottom: 4px; font-size: 11px; color: var(--text-secondary); font-weight: 600;">ğŸ“ ì—°ì‚°ì </div>
                    <a href="/bookings-yeonsan.html" class="menu-item" data-role="Front"><span class="menu-item-icon">âš¾</span><span>ì•¼êµ¬</span></a>
                    <a href="/bookings-yeonsan-youth.html" class="menu-item" data-role="Front"><span class="menu-item-icon">ğŸ‘¶</span><span>ì•¼êµ¬(ìœ ì†Œë…„)</span></a>
                    <a href="/bookings-yeonsan-training.html" class="menu-item" data-role="Front"><span class="menu-item-icon">ğŸ’ª</span><span>íŠ¸ë ˆì´ë‹+í•„ë¼í…ŒìŠ¤</span></a>
                    <div style="margin-left: 12px; margin-top: 12px; margin-bottom: 4px; font-size: 11px; color: var(--text-secondary); font-weight: 600;">ğŸŸï¸ ëŒ€ê´€</div>
                    <a href="/rentals.html" class="menu-item" data-role="Front"><span class="menu-item-icon">ğŸŸï¸</span><span>ëŒ€ê´€ ê´€ë¦¬</span></a>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">í›ˆë ¨ ê´€ë¦¬</div>
                    <a href="/training-logs.html" class="menu-item" data-role="Coach"><span class="menu-item-icon">ğŸ“</span><span>í›ˆë ¨ ê¸°ë¡</span></a>
                    <a href="/rankings.html" class="menu-item" data-role="Coach"><span class="menu-item-icon">ğŸ†</span><span>í›ˆë ¨ ë­í‚¹</span></a>
                    <a href="/training-stats.html" class="menu-item" data-role="Coach"><span class="menu-item-icon">ğŸ“ˆ</span><span>í›ˆë ¨ í†µê³„</span></a>
                </div>
            </nav>
        </aside>
        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <h1 class="page-title">ì´ìš©ê¶Œ ë¯¸ì—°ê²° ì˜ˆì•½ ê´€ë¦¬</h1>
                    <div class="search-box">
                        <input type="text" placeholder="ê²€ìƒ‰..." id="global-search">
                    </div>
                </div>
                <div class="topbar-right">
                    <button class="notification-btn">ğŸ””</button>
                    <button class="user-menu-btn">ğŸ‘¤</button>
                </div>
            </header>
            <div class="content-area">
                <div class="card">
                    <div class="card-header" style="display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px;">
                        <div>
                            <h2 class="card-title">âš ï¸ ì´ìš©ê¶Œì´ ì—°ê²°ë˜ì§€ ì•Šì€ íšŒì› ì˜ˆì•½</h2>
                            <p class="card-desc" style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted);">ìˆ˜ì •ì—ì„œ ì´ìš©ê¶Œì„ ì„ íƒÂ·ì €ì¥í•˜ë©´ ì—°ê²°ë˜ë©°, ì´ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ìˆ˜ì • í›„ ì•„ë˜ ìƒˆë¡œê³ ì¹¨ì„ ëˆ„ë¥´ë©´ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
                        </div>
                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                            <button type="button" class="btn btn-primary btn-sm" id="btn-bulk-link">ğŸ”— 1ê°œ ë³´ìœ  íšŒì› ì¼ê´„ ì—°ê²°</button>
                            <button type="button" class="btn btn-secondary btn-sm" id="btn-refresh-list">ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="loading" class="members-stats-loading" style="padding: 24px; text-align: center;">ë¡œë”© ì¤‘...</div>
                        <div id="error" style="display: none; padding: 24px; color: var(--danger);"></div>
                        <div id="empty" style="display: none; padding: 24px; text-align: center; color: var(--text-muted);">ì´ìš©ê¶Œì´ ì—°ê²°ë˜ì§€ ì•Šì€ íšŒì› ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        <div id="table-wrap" style="display: none;">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ì˜ˆì•½ ID</th>
                                            <th>ë‚ ì§œ</th>
                                            <th>ì‹œê°„</th>
                                            <th>íšŒì›</th>
                                            <th>ì—°ë½ì²˜</th>
                                            <th>ì‹œì„¤</th>
                                            <th>ìƒíƒœ</th>
                                            <th>ìˆ˜ì •</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody"></tbody>
                                </table>
                            </div>
                            <p id="count-msg" style="margin-top: 12px; font-size: 13px; color: var(--text-muted);"></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="/js/common.js"></script>
    <script>
(function() {
    // ê´€ë¦¬ì(Admin)ë§Œ ì ‘ê·¼ ê°€ëŠ¥
    var role = (typeof App !== 'undefined' && App.currentRole) ? String(App.currentRole).toUpperCase() : '';
    if (role !== 'ADMIN') {
        var main = document.querySelector('.main-content');
        if (main) {
            var content = main.querySelector('.content-area');
            if (content) {
                content.innerHTML = '<div class="card" style="padding: 24px; text-align: center;"><p style="color: var(--text-muted); margin: 0;">ì´ìš©ê¶Œ ë¯¸ì—°ê²° ì˜ˆì•½ ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p style="margin-top: 12px;"><a href="/" class="btn btn-primary">ëŒ€ì‹œë³´ë“œë¡œ ì´ë™</a></p></div>';
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof App !== 'undefined' && App.showNotification) {
                App.showNotification('ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë©”ë‰´ì…ë‹ˆë‹¤.', 'error');
            }
        });
        return;
    }

    const loading = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const emptyEl = document.getElementById('empty');
    const tableWrap = document.getElementById('table-wrap');
    const tbody = document.getElementById('tbody');
    const countMsg = document.getElementById('count-msg');

    function formatDate(d) {
        if (!d) return '-';
        const dt = new Date(d);
        return dt.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }
    function formatTime(d) {
        if (!d) return '-';
        const dt = new Date(d);
        return dt.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
    }
    function escapeHtml(s) {
        if (s == null || s === '') return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    async function load() {
        loading.style.display = 'block';
        errorEl.style.display = 'none';
        emptyEl.style.display = 'none';
        tableWrap.style.display = 'none';
        tbody.innerHTML = '';

        try {
            const list = await App.api.get('/bookings/without-member-product');
            loading.style.display = 'none';

            if (!list || list.length === 0) {
                emptyEl.style.display = 'block';
                countMsg.textContent = 'ì´ 0ê±´';
                return;
            }

            // ì§€ì (branch) + ì‹œì„¤íƒ€ì…(facilityType)ì— ë§ëŠ” ì˜ˆì•½ í˜ì´ì§€ë¡œ ì—°ê²° (í•´ë‹¹ ì˜ˆì•½ ë‚´ìš©ì´ ê·¸ëŒ€ë¡œ ë¡œë“œë˜ë„ë¡)
            function getEditPage(branch, facilityType) {
                const b = (branch || '').toUpperCase();
                const t = (facilityType || '').toUpperCase();
                if (t === 'RENTAL') return '/rentals.html';
                if (b === 'SAHA') {
                    if (t === 'TRAINING_FITNESS') return '/bookings-saha-training.html';
                    return '/bookings.html';
                }
                if (b === 'YEONSAN') {
                    if (t === 'TRAINING_FITNESS') return '/bookings-yeonsan-training.html';
                    return '/bookings-yeonsan.html';
                }
                return '/bookings.html';
            }
            list.forEach(function(b) {
                const facility = b.facility || {};
                const member = b.member || {};
                const branch = facility.branch || 'SAHA';
                const facilityType = facility.facilityType || '';
                const editUrl = getEditPage(branch, facilityType) + '?edit=' + b.id;
                const tr = document.createElement('tr');
                tr.innerHTML =
                    '<td>' + escapeHtml(String(b.id)) + '</td>' +
                    '<td>' + escapeHtml(formatDate(b.startTime)) + '</td>' +
                    '<td>' + escapeHtml(formatTime(b.startTime) + '~' + formatTime(b.endTime)) + '</td>' +
                    '<td>' + escapeHtml(member.name || '-') + ' <span style="color:var(--text-muted); font-size:12px;">(' + escapeHtml(member.memberNumber || '') + ')</span></td>' +
                    '<td>' + escapeHtml(member.phoneNumber || '-') + '</td>' +
                    '<td>' + escapeHtml(facility.name || '-') + '</td>' +
                    '<td>' + escapeHtml(b.status || '-') + '</td>' +
                    '<td><a href="' + escapeHtml(editUrl) + '" class="btn btn-sm btn-secondary">ìˆ˜ì •</a></td>';
                tbody.appendChild(tr);
            });

            tableWrap.style.display = 'block';
            countMsg.textContent = 'ì´ ' + list.length + 'ê±´. ìˆ˜ì • í˜ì´ì§€ì—ì„œ í•´ë‹¹ ì˜ˆì•½ì„ ì—´ì–´ ì´ìš©ê¶Œì„ ì„ íƒÂ·ì €ì¥í•˜ë©´ ì—°ê²°ë©ë‹ˆë‹¤.';
        } catch (e) {
            loading.style.display = 'none';
            errorEl.style.display = 'block';
            errorEl.textContent = 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ' + (e.message || e);
        }
    }

    var refreshBtn = document.getElementById('btn-refresh-list');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            load();
            if (typeof App !== 'undefined' && App.showNotification) {
                App.showNotification('ëª©ë¡ì„ ìƒˆë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
            }
        });
    }

    // 1ê°œ ë³´ìœ  íšŒì› ì¼ê´„ ì—°ê²°: ë³´ìœ  ì´ìš©ê¶Œì´ 1ê°œì¸ ì˜ˆì•½ë§Œ ìë™ ì—°ê²°, 2ê°œ ì´ìƒì€ ìˆ˜ë™ ì„ íƒ ì•ˆë‚´
    var bulkLinkBtn = document.getElementById('btn-bulk-link');
    if (bulkLinkBtn) {
        bulkLinkBtn.addEventListener('click', function() {
            (async function() {
                bulkLinkBtn.disabled = true;
                try {
                    var list = await App.api.get('/bookings/without-member-product');
                    if (!list || list.length === 0) {
                        if (window.App && App.showNotification) App.showNotification('ì—°ê²°í•  ë¯¸ì—°ê²° ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
                        return;
                    }
                    var memberProductsCache = {};
                    function getUsableProducts(memberId) {
                        if (memberProductsCache[memberId] !== undefined) return Promise.resolve(memberProductsCache[memberId]);
                        return App.api.get('/member-products?memberId=' + encodeURIComponent(memberId) + '&status=ACTIVE')
                            .then(function(arr) {
                                var usable = (arr || []).filter(function(mp) {
                                    if ((mp.status || '').toUpperCase() !== 'ACTIVE') return false;
                                    if (mp.isActuallyExpired === true) return false;
                                    var rem = mp.remainingCount;
                                    if (rem != null && rem !== '' && Number(rem) <= 0) return false;
                                    return true;
                                });
                                memberProductsCache[memberId] = usable;
                                return usable;
                            });
                    }
                    var linked = 0, multiple = 0, zero = 0;
                    for (var i = 0; i < list.length; i++) {
                        var b = list[i];
                        var memberId = (b.member || {}).id;
                        if (!memberId) { zero++; continue; }
                        var usable = await getUsableProducts(memberId);
                        if (usable.length === 1) {
                            await App.api.put('/bookings/' + b.id, { memberProductId: usable[0].id });
                            linked++;
                        } else if (usable.length === 0) {
                            zero++;
                        } else {
                            multiple++;
                        }
                    }
                    var msg = linked + 'ê±´ ì—°ê²°ë¨.';
                    if (multiple > 0) msg += ' ì´ìš©ê¶Œ 2ê°œ ì´ìƒì¸ ì˜ˆì•½ ' + multiple + 'ê±´ì€ ìˆ˜ì •ì—ì„œ ì„ íƒí•´ ì£¼ì„¸ìš”.';
                    if (zero > 0) msg += ' ë³´ìœ  ì´ìš©ê¶Œ ì—†ìŒ ' + zero + 'ê±´ì€ ìˆ˜ì •ì—ì„œ í™•ì¸í•´ ì£¼ì„¸ìš”.';
                    if (window.App && App.showNotification) App.showNotification(msg, linked > 0 ? 'success' : 'info');
                    load();
                } catch (e) {
                    if (window.App && App.showNotification) App.showNotification('ì¼ê´„ ì—°ê²° ì‹¤íŒ¨: ' + (e.message || e), 'error');
                } finally {
                    bulkLinkBtn.disabled = false;
                }
            })();
        });
    }

    if (typeof App !== 'undefined' && App.api) {
        load();
    } else {
        document.addEventListener('DOMContentLoaded', function() {
            if (window.App && window.App.api) load();
            else setTimeout(load, 500);
        });
    }
})();
    </script>
</body>
</html>
